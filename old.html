
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="csrf-token" content="OF04UjNMRTsakL4T5yYS1ioWFwPRryXAwKWvf1aW">
    
    <title>SIMS-CMRU</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;700&family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- App CSS -->
    <link href="https://adicet.cmru.ac.th/sim/dashboard.css" rel="stylesheet">
    </head>
<body>

    
    <!-- Navbar -->
    <!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="spinner-border text-warning loading-spinner" role="status">
      <span class="visually-hidden">กำลังโหลด...</span>
    </div>
  </div>

  <!-- Alert Message -->
  <div id="alertBox" class="alert-box">
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <strong id="alertTitle">สำเร็จ!</strong> <span id="alertMessage">บันทึกข้อมูลเรียบร้อยแล้ว</span>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  </div>

  <!-- Decoration Elements -->
  <div class="cloud-shape cloud-1"></div>
  

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white">
    <div class="container">
        <a class="navbar-brand" href="/sims">
            <img src="/sim/logo-sim.png" alt="logo-SIMs" class="school-logo">
            <div>
              <span class="fs-5 fw-bold">ระบบจัดการโครงการนวัตกรรมเพื่อสังคม</span><br>
              <small>Social Innovation Management System</small>
            </div>
          </a>
          
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="/sims"><i class="fas fa-home me-1"></i> หน้าหลัก</a>
          </li>
          <li class="nav-item">
            <!-- <a class="nav-link" href="/sid/about.html"><i class="fas fa-info-circle me-1"></i> จัดการโครงการ</a> -->
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/sims/contact"><i class="fas fa-envelope me-1"></i> ติดต่อ SID-CMRU</a>
          </li>
          <li class="nav-item" id="loginMenuItem">
            <a class="btn btn-login" href="/sims/login"><i class="fas fa-sign-in-alt me-1"></i> เข้าสู่ระบบ</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
    
  <!-- Page Header -->
  <div class="page-header">
    <div class="container">
      <h1 class="page-title">โครงการนวัตกรรมเพื่อสังคม</h1>
      <p class="page-subtitle">สถานะโครงการของคุณ</p>
      <div class="d-flex justify-content-center flex-wrap mt-4">
        <div class="stats-badge">
          <i class="fas fa-calendar-alt"></i> วันที่ยื่น: <span id="submissionDate">-</span>
        </div>
        <div class="stats-badge">
          <i class="fas fa-history"></i> ระยะเวลาดำเนินการ: <span id="projectDuration">-</span>
        </div>
        <div id="nextStepBadge" class="stats-badge badge-glow">
          <i class="fas fa-tasks"></i> ขั้นตอนถัดไป: <span id="nextStep">-</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container dashboard-container">
    <div class="row">
      <!-- Left Column: Status and Timeline -->
      <div class="col-lg-8">
        <!-- Status Tracker -->
        <div class="dashboard-card">
          <div class="dashboard-card-header">
            <h2 class="dashboard-card-title"><i class="fas fa-chart-line"></i> สถานะโครงการ</h2>
          </div>
          <div class="dashboard-card-body">
            <!-- Status Tracker -->
            <div class="status-tracker">
              <div class="status-line"></div>
              <div class="status-progress" id="statusProgressBar"></div>
              <div class="status-items">
                <div class="status-item" data-status="waiting">
                  <div class="status-icon">
                    <i class="fas fa-hourglass-half"></i>
                  </div>
                  <div class="status-text">รอการตรวจรับ</div>
                </div>
                <div class="status-item" data-status="reviewing">
                  <div class="status-icon">
                    <i class="fas fa-clipboard-check"></i>
                  </div>
                  <div class="status-text">เจ้าหน้าที่ตรวจรับแล้ว</div>
                </div>
                <div class="status-item" data-status="preparing">
                  <div class="status-icon">
                    <i class="fas fa-laptop-code"></i>
                  </div>
                  <div class="status-text">เตรียมข้อมูลนำเสนอ</div>
                </div>
                <div class="status-item" data-status="approved">
                  <div class="status-icon">
                    <i class="fas fa-check-circle"></i>
                  </div>
                  <div class="status-text">อนุมัติโครงการ</div>
                </div>
              </div>
            </div>

            <!-- Current Status Card -->
            <div id="currentStatusCard" class="current-status-card status-waiting">
              <h5 class="status-title" id="statusTitle">
                <i class="fas fa-hourglass-half"></i> กำลังโหลดข้อมูล...
              </h5>
              <p class="status-description" id="statusDescription">
                กรุณารอสักครู่ ระบบกำลังโหลดข้อมูลสถานะโครงการของคุณ
              </p>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons" id="actionButtonsContainer">
              <!-- ปุ่มจะถูกเพิ่มตามสถานะด้วย JavaScript -->
            </div>
          </div>
        </div>

        <!-- Timeline Section -->
        <div class="dashboard-card">
          <div class="dashboard-card-header">
            <h2 class="dashboard-card-title"><i class="fas fa-history"></i> ประวัติการดำเนินการ</h2>
          </div>
          <div class="dashboard-card-body">
            <div class="timeline" id="projectTimeline">
              <!-- Timeline items จะถูกเพิ่มด้วย JavaScript -->
            </div>
          </div>
        </div>

        <!-- Notifications (ย้ายมาอยู่ด้านซ้าย) -->
        <div class="dashboard-card">
          <div class="dashboard-card-header">
            <h2 class="dashboard-card-title"><i class="fas fa-bell"></i> การแจ้งเตือน</h2>
          </div>
          <div class="dashboard-card-body">
            <div class="notification-scroll" id="notificationsContainer">
              <!-- Notifications will be added by JavaScript -->
            </div>
          </div>
        </div>

        <!-- Upload Section (จะแสดงเฉพาะเมื่อสถานะเป็น preparing) -->
        <div class="dashboard-card" id="uploadSection" style="display: none;">
          <div class="dashboard-card-header">
            <h2 class="dashboard-card-title"><i class="fas fa-upload"></i> อัปโหลดเอกสารนำเสนอ</h2>
          </div>
          <div class="dashboard-card-body">
            <p class="mb-3">กรุณาอัปโหลดเอกสารหรือสไลด์สำหรับการนำเสนอโครงการตามแบบฟอร์มที่กำหนด</p>
            
            <div class="file-upload-section">
              <div class="file-upload-container" id="presentationContainer">
                <div class="file-upload-content">
                  <div class="file-upload-icon">
                    <i class="fas fa-file-powerpoint"></i>
                  </div>
                  <div class="file-upload-text">คลิกหรือลากไฟล์มาวางที่นี่</div>
                  <div class="file-format-info">รองรับไฟล์ .ppt, .pptx, .pdf ขนาดไม่เกิน 15MB</div>
                </div>
                <input type="file" id="presentationFile" class="file-input" accept=".ppt,.pptx,.pdf">
                <div class="upload-progress" id="presentationProgress">
                  <div class="upload-progress-bar"></div>
                </div>
              </div>
            </div>
            
            <button type="button" id="submitPresentation" class="btn btn-action btn-info mt-3">
              <i class="fas fa-paper-plane"></i> ส่งเอกสารนำเสนอ
            </button>
          </div>
        </div>

        <!-- Feedback Section (จะแสดงเฉพาะเมื่อสถานะเป็น rejected) -->
        <div class="dashboard-card" id="feedbackSection" style="display: none;">
          <div class="dashboard-card-header">
            <h2 class="dashboard-card-title"><i class="fas fa-comment-alt"></i> ข้อเสนอแนะจากคณะกรรมการ</h2>
          </div>
          <div class="dashboard-card-body">
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-circle me-2"></i>
              <span>โครงการของคุณไม่ผ่านการอนุมัติ กรุณาอ่านข้อเสนอแนะด้านล่าง</span>
            </div>
            <div class="feedback-content" id="feedbackContent">
              <!-- Feedback content จะถูกเพิ่มด้วย JavaScript -->
            </div>
            <div class="mt-3">
              <button type="button" class="btn btn-action btn-primary" id="resubmitBtn">
                <i class="fas fa-redo"></i> ส่งข้อเสนอใหม่
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column: Project Details and Files -->
      <div class="col-lg-4">
        <!-- Project Details -->
        <div class="dashboard-card">
          <div class="dashboard-card-header">
            <h2 class="dashboard-card-title"><i class="fas fa-info-circle"></i> ข้อมูลโครงการ</h2>
          </div>
          <div class="dashboard-card-body">
            <dl class="project-details">
              <dt>หมายเลขอ้างอิง</dt>
              <dd><span class="reference-number" id="referenceNumber">-</span></dd>
              
              <dt>ชื่อโครงการ</dt>
              <dd id="projectTitle">-</dd>
              
              <dt>ประเภทนวัตกรรม</dt>
              <dd id="innovationType">-</dd>
              
              <dt>จังหวัดที่ดำเนินโครงการ</dt>
              <dd id="projectProvince">-</dd>
              
              <dt>งบประมาณที่ขอ</dt>
              <dd id="requestedBudget">-</dd>
              
              <dt>ผู้ได้รับประโยชน์</dt>
              <dd id="beneficiaries">-</dd>
            </dl>
          </div>
        </div>

        <!-- Documents Section -->
        <div class="dashboard-card">
          <div class="dashboard-card-header">
            <h2 class="dashboard-card-title"><i class="fas fa-file-alt"></i> เอกสารโครงการ</h2>
          </div>
          <div class="dashboard-card-body">
            <div class="document-list">
              <div class="document-item">
                <div class="document-icon text-primary">
                  <i class="fas fa-file-word"></i>
                </div>
                <div class="document-info">
                  <div class="document-title">ข้อเสนอโครงการ (Word)</div>
                  <div class="document-meta">อัปโหลดเมื่อ: <span id="wordUploadDate">-</span></div>
                </div>
                <div class="document-actions">
                  <button class="btn btn-sm btn-download btn-primary" id="downloadWordBtn" disabled>
                    <i class="fas fa-download"></i> ดาวน์โหลด
                  </button>
                </div>
              </div>
              
              <div class="document-item">
                <div class="document-icon text-danger">
                  <i class="fas fa-file-pdf"></i>
                </div>
                <div class="document-info">
                  <div class="document-title">ข้อเสนอโครงการ (PDF)</div>
                  <div class="document-meta">อัปโหลดเมื่อ: <span id="pdfUploadDate">-</span></div>
                </div>
                <div class="document-actions">
                  <button class="btn btn-sm btn-download btn-danger" id="downloadPdfBtn" disabled>
                    <i class="fas fa-download"></i> ดาวน์โหลด
                  </button>
                </div>
              </div>
              
              <div class="document-item">
                <div class="document-icon text-secondary">
                  <i class="fas fa-file-alt"></i>
                </div>
                <div class="document-info">
                  <div class="document-title">หลักฐานประกอบกิจการ</div>
                  <div class="document-meta">อัปโหลดเมื่อ: <span id="businessUploadDate">-</span></div>
                </div>
                <div class="document-actions">
                  <button class="btn btn-sm btn-download btn-secondary" id="downloadBusinessBtn" disabled>
                    <i class="fas fa-download"></i> ดาวน์โหลด
                  </button>
                </div>
              </div>
              
              <div class="document-item">
                <div class="document-icon text-warning">
                  <i class="fas fa-file-powerpoint"></i>
                </div>
                <div class="document-info">
                  <div class="document-title">แบบฟอร์มนำเสนอโครงการ</div>
                  <div class="document-meta">แบบฟอร์มมาตรฐาน</div>
                </div>
                <div class="document-actions">
                  <button class="btn btn-sm btn-download btn-warning" id="downloadTemplateBtn">
                    <i class="fas fa-download"></i> ดาวน์โหลด
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Help Section -->
        <div class="dashboard-card">
          <!-- <div class="dashboard-card-header">
            <h2 class="dashboard-card-title"><i class="fas fa-question-circle"></i> ต้องการความช่วยเหลือ?</h2>
          </div>
          <div class="dashboard-card-body">
            <div class="d-grid gap-2">
              <button type="button" class="btn btn-outline-primary" id="contactStaffBtn">
                <i class="fas fa-headset me-2"></i> ติดต่อเจ้าหน้าที่
              </button>
              <button type="button" class="btn btn-outline-primary" id="faqBtn">
                <i class="fas fa-book me-2"></i> คำถามที่พบบ่อย
              </button>
            </div>
          </div> -->
        </div>
      </div>
    </div>
  </div>

  <!-- Modal สำหรับติดต่อเจ้าหน้าที่ -->
  <div class="modal fade" id="contactStaffModal" tabindex="-1" aria-labelledby="contactStaffModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="contactStaffModalLabel">ติดต่อเจ้าหน้าที่</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="contactForm">
            <div class="mb-3">
              <label for="contactSubject" class="form-label">หัวข้อ</label>
              <input type="text" class="form-control" id="contactSubject" required>
            </div>
            <div class="mb-3">
              <label for="contactMessage" class="form-label">ข้อความ</label>
              <textarea class="form-control" id="contactMessage" rows="5" required></textarea>
            </div>
          </form>
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <span>หรือติดต่อโดยตรงทาง:</span>
            <p class="mt-2 mb-0">อีเมล: sidcmru@g.cmru.ac.th<br>โทร: (+66) 65-0161100<br>เวลาทำการ: จันทร์-ศุกร์ 8:00-16:30 น.</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
          <button type="button" class="btn btn-primary" id="sendContactBtn">ส่งข้อความ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal สำหรับ FAQ -->
  <div class="modal fade" id="faqModal" tabindex="-1" aria-labelledby="faqModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="faqModalLabel">คำถามที่พบบ่อย</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="accordion" id="faqAccordion">
            <div class="accordion-item">
              <h2 class="accordion-header" id="faqHeadingOne">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#faqCollapseOne" aria-expanded="true" aria-controls="faqCollapseOne">
                  ระยะเวลาในการพิจารณาโครงการเป็นเท่าไร?
                </button>
              </h2>
              <div id="faqCollapseOne" class="accordion-collapse collapse show" aria-labelledby="faqHeadingOne" data-bs-parent="#faqAccordion">
                <div class="accordion-body">
                  โดยปกติจะใช้เวลาประมาณ 14-21 วันทำการในการพิจารณาโครงการ โดยแบ่งเป็นการตรวจรับและตรวจสอบเอกสารเบื้องต้น 7-10 วัน และการพิจารณาโดยคณะกรรมการอีก 7-10 วัน
                </div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header" id="faqHeadingTwo">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faqCollapseTwo" aria-expanded="false" aria-controls="faqCollapseTwo">
                  หากโครงการไม่ผ่านการอนุมัติ สามารถยื่นใหม่ได้หรือไม่?
                </button>
              </h2>
              <div id="faqCollapseTwo" class="accordion-collapse collapse" aria-labelledby="faqHeadingTwo" data-bs-parent="#faqAccordion">
                <div class="accordion-body">
                  สามารถยื่นใหม่ได้ โดยควรปรับปรุงตามข้อเสนอแนะจากคณะกรรมการ และต้องยื่นใหม่ภายในระยะเวลาที่กำหนด โดยสามารถคลิกที่ปุ่ม "ส่งข้อเสนอใหม่" เพื่อเริ่มกระบวนการยื่นข้อเสนอใหม่อีกครั้ง
                </div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header" id="faqHeadingThree">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faqCollapseThree" aria-expanded="false" aria-controls="faqCollapseThree">
                  เมื่อไหร่จะได้รับแจ้งให้เตรียมข้อมูลสำหรับการนำเสนอ?
                </button>
              </h2>
              <div id="faqCollapseThree" class="accordion-collapse collapse" aria-labelledby="faqHeadingThree" data-bs-parent="#faqAccordion">
                <div class="accordion-body">
                  เมื่อโครงการผ่านการตรวจรับและได้รับการคัดเลือกให้นำเสนอต่อคณะกรรมการ ท่านจะได้รับการแจ้งเตือนผ่านอีเมลและระบบแจ้งเตือนในแดชบอร์ด โดยปกติจะได้รับแจ้งภายใน 7-14 วันหลังจากยื่นข้อเสนอโครงการ
                </div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header" id="faqHeadingFour">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faqCollapseFour" aria-expanded="false" aria-controls="faqCollapseFour">
                  หลังจากโครงการได้รับการอนุมัติแล้ว จะต้องดำเนินการอย่างไรต่อไป?
                </button>
              </h2>
              <div id="faqCollapseFour" class="accordion-collapse collapse" aria-labelledby="faqHeadingFour" data-bs-parent="#faqAccordion">
                <div class="accordion-body">
                  หลังจากโครงการได้รับการอนุมัติ ท่านจะได้รับการติดต่อจากเจ้าหน้าที่เพื่อนัดหมายการทำสัญญาและการเบิกจ่ายงบประมาณ โดยควรเตรียมเอกสารประกอบตามที่ระบุในคู่มือการดำเนินโครงการ
                </div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header" id="faqHeadingFive">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faqCollapseFive" aria-expanded="false" aria-controls="faqCollapseFive">
                  สามารถแก้ไขข้อมูลในข้อเสนอโครงการหลังจากส่งแล้วได้หรือไม่?
                </button>
              </h2>
              <div id="faqCollapseFive" class="accordion-collapse collapse" aria-labelledby="faqHeadingFive" data-bs-parent="#faqAccordion">
                <div class="accordion-body">
                  ไม่สามารถแก้ไขข้อมูลในข้อเสนอโครงการหลังจากส่งแล้ว แต่หากมีข้อมูลที่จำเป็นต้องแก้ไขหรือเพิ่มเติม สามารถติดต่อเจ้าหน้าที่โดยตรงผ่านช่องทางการติดต่อในแดชบอร์ด หรืออีเมล sidcmru@g.cmru.ac.th
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">ปิด</button>
        </div>
      </div>
    </div>
  </div>


    <!-- Footer -->
<footer class="footer">
    <div class="container">
      <div class="row">
        <div class="col-lg-4 col-md-6 mb-4 mb-md-0">
          <h5>SID-CMRU</h5>
          <p>หน่วยขับเคลื่อนนวัตกรรมเพื่อสังคมประจำพื้นที่ภาคเหนือตอนบน 1<br>
          วิทยาลัยพัฒนาเศรษฐกิจและเทคโนโลยีชุมชนเอเชีย (adiCET)<br>
          มหาวิทยาลัยราชภัฏเชียงใหม่</p>
          <div class="social-icons">
            <a href="#" class="social-icon"><i class="fab fa-facebook-f"></i></a>
            <a href="#" class="social-icon"><i class="fab fa-twitter"></i></a>
            <a href="#" class="social-icon"><i class="fab fa-instagram"></i></a>
            <a href="#" class="social-icon"><i class="fab fa-line"></i></a>
          </div>
        </div>
        <div class="col-lg-2 col-md-6 mb-4 mb-md-0">
          <h5>เมนูหลัก</h5>
          <div class="footer-links">
            <a href="/sid/index.html"><i class="fas fa-home me-2"></i>หน้าหลัก</a>
            <a href="/sid"><i class="fas fa-info-circle me-2"></i>เกี่ยวกับ SID-CMRU</a>
            <a href="/sid/contact.html"><i class="fas fa-envelope me-2"></i>ติดต่อเรา</a>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-4 mb-md-0">
          <h5>ติดต่อเรา</h5>
          <p><i class="fas fa-map-marker-alt me-2"></i> 180 หมู่ 7 ถนนโชตนา<br>ตำบลขี้เหล็ก อำเภอแม่ริม<br>จังหวัดเชียงใหม่ 50180</p>
          <p><i class="fas fa-phone-alt me-2"></i> (+66) 65-0161100</p>
          <p><i class="fas fa-envelope me-2"></i> sidcmru@g.cmru.ac.th</p>
        </div>
        <div class="col-lg-3 col-md-6">
          <h5>รับข่าวสาร</h5>
          <p>ลงทะเบียนเพื่อรับข่าวสารและกิจกรรมใหม่ๆ จาก SID-CMRU</p>
          <div class="input-group mb-3">
            <input type="email" class="form-control" placeholder="อีเมล์ของคุณ" aria-label="Email" aria-describedby="button-addon2">
            <button class="btn btn-warning" type="button" id="button-addon2">สมัคร</button>
          </div>
        </div>
      </div>
      <div class="footer-bottom">
        <div class="row">
          <div class="col-md-8">
            <p>&copy; 2568 SID-CMRU หน่วยขับเคลื่อนนวัตกรรมเพื่อสังคมประจำพื้นที่ภาคเหนือตอนบน 1. สงวนลิขสิทธิ์.</p>
          </div>
          <div class="col-md-4 text-md-end">
            <a href="#" class="text-white text-decoration-none me-3">นโยบายความเป็นส่วนตัว</a>
            <a href="#" class="text-white text-decoration-none">เงื่อนไขการใช้งาน</a>
          </div>
        </div>
      </div>
    </div>
  </footer>    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
          // แสดง loading overlay
          const loadingOverlay = document.getElementById('loadingOverlay');
          loadingOverlay.classList.add('show');
          
          // ดึงข้อมูล Token จาก localStorage
          const authToken = localStorage.getItem('authToken');
          
          if (!authToken) {
            // ถ้าไม่มี Token ให้ redirect ไปหน้า login
            window.location.href = '/sims/login';
            return;
          }
          
          // ดึงข้อมูลผู้ใช้จาก Token
          validateToken(authToken)
            .then(response => {
              if (response.success) {
                // อัพเดท UI สำหรับผู้ใช้ที่ล็อกอิน
                updateLoginState(true, response.user);
                // console.log(response.user);
                // ตรวจสอบว่าผู้ใช้เป็น admin หรือไม่
                if (response.user.role === 'admin') {
                  // ถ้าเป็น admin ให้ redirect ไปหน้า admin
                  window.location.href = '/sims/admin';
                  return; // ออกจากฟังก์ชันเพื่อไม่ให้ทำงานต่อ
                }
                // ตรวจสอบว่าผู้ใช้มี proposal หรือไม่
                if (!response.user.proposals) {
                  // ถ้ายังไม่มี proposal ให้ redirect ไปหน้า submit
                  showAlert('ไม่พบข้อเสนอโครงการ', 'กรุณาส่งข้อเสนอโครงการก่อน', 'warning');
                  setTimeout(() => {
                    window.location.href = '/sims/submit';
                  }, 2000);
                  return null;
                }
                
                // ดึงข้อมูลโครงการ
                return getProposalData(authToken);
              } else {
                throw new Error(response.message || 'Token ไม่ถูกต้อง');
              }
            })
            .then(proposalData => {
              if (!proposalData) return;
              
              // ตรวจสอบข้อมูลที่ได้รับ
              if (!proposalData.success) {
                throw new Error(proposalData.message || 'ไม่สามารถดึงข้อมูลโครงการได้');
              }
              
              // อัพเดทข้อมูลโครงการ
              updateProposalInfo(proposalData);
              // อัพเดทสถานะโครงการ
              updateStatusUI(proposalData.proposal.status);
              // อัพเดทประวัติการดำเนินการ
              updateTimeline(proposalData.statusHistory);
              // อัพเดทการแจ้งเตือน
              updateNotifications(proposalData.notifications);
              
              // แสดงส่วนอื่นๆ ตามสถานะโครงการ
              toggleSectionsByStatus(proposalData.proposal.status, proposalData);
              
              // ซ่อน loading overlay
              loadingOverlay.classList.remove('show');
            })
            .catch(error => {
              console.error('Error:', error);
              showAlert('เกิดข้อผิดพลาด', error.message || 'ไม่สามารถโหลดข้อมูลได้', 'danger');
              
              // ซ่อน loading overlay
              loadingOverlay.classList.remove('show');
            });
          
          // ********** Event Listeners **********
          
          // ปุ่ม FAQ และติดต่อเจ้าหน้าที่
          // document.getElementById('faqBtn').addEventListener('click', function() {
          //   const faqModal = new bootstrap.Modal(document.getElementById('faqModal'));
          //   faqModal.show();
          // });
          
          document.getElementById('contactStaffBtn').addEventListener('click', function() {
            const contactModal = new bootstrap.Modal(document.getElementById('contactStaffModal'));
            contactModal.show();
          });
          
          // ปุ่มส่งข้อความถึงเจ้าหน้าที่
          document.getElementById('sendContactBtn').addEventListener('click', function() {
            const subject = document.getElementById('contactSubject').value;
            const message = document.getElementById('contactMessage').value;
            
            if (!subject || !message) {
              showAlert('ข้อมูลไม่ครบถ้วน', 'กรุณากรอกหัวข้อและข้อความ', 'warning');
              return;
            }
            
            // ในสถานการณ์จริงจะส่งข้อมูลไปยัง API
            showAlert('สำเร็จ', 'ส่งข้อความถึงเจ้าหน้าที่เรียบร้อยแล้ว', 'success');
            
            // ปิด Modal
            bootstrap.Modal.getInstance(document.getElementById('contactStaffModal')).hide();
            
            // เคลียร์ฟอร์ม
            document.getElementById('contactForm').reset();
          });
          
          // ปุ่มส่งข้อเสนอใหม่
          document.addEventListener('click', function(e) {
            if (e.target && e.target.id === 'resubmitBtn') {
              if (confirm('คุณต้องการส่งข้อเสนอโครงการใหม่หรือไม่?')) {
                window.location.href = '/sims/submit';
              }
            }
          });
          
          // ปุ่มดาวน์โหลดเอกสาร
          document.getElementById('downloadWordBtn').addEventListener('click', function() {
            downloadDocument('word');
          });
          
          document.getElementById('downloadPdfBtn').addEventListener('click', function() {
            downloadDocument('pdf');
          });
          
          document.getElementById('downloadBusinessBtn').addEventListener('click', function() {
            downloadDocument('business');
          });
          
          document.getElementById('downloadTemplateBtn').addEventListener('click', function() {
            // ดาวน์โหลดแบบฟอร์มนำเสนอ
            window.location.href = '/sidfile/templates/presentation_template.pptx';
          });
          
          // ตั้งค่า File Upload
          const presentationFile = document.getElementById('presentationFile');
          if (presentationFile) {
            presentationFile.addEventListener('change', function() {
              const file = this.files[0];
              if (!file) return;
              
              // ตรวจสอบขนาดไฟล์
              if (file.size > 15 * 1024 * 1024) { // 15MB
                showAlert('ไฟล์มีขนาดใหญ่เกินไป', 'กรุณาอัปโหลดไฟล์ที่มีขนาดไม่เกิน 15MB', 'danger');
                this.value = '';
                return;
              }
              
              // ตรวจสอบประเภทไฟล์
              const fileType = file.type;
              const validTypes = [
                'application/vnd.ms-powerpoint',
                'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                'application/pdf'
              ];
              
              if (!validTypes.includes(fileType)) {
                showAlert('ประเภทไฟล์ไม่ถูกต้อง', 'รองรับเฉพาะไฟล์ .ppt, .pptx, .pdf', 'danger');
                this.value = '';
                return;
              }
              
              // แสดง progress bar
              const progressBar = document.querySelector('#presentationProgress .upload-progress-bar');
              document.getElementById('presentationProgress').style.display = 'block';
              
              let progress = 0;
              const interval = setInterval(() => {
                progress += 5;
                progressBar.style.width = `${progress}%`;
                
                if (progress >= 100) {
                  clearInterval(interval);
                  
                  // เปลี่ยนสถานะ container
                  document.getElementById('presentationContainer').classList.add('has-file');
                  
                  // อัพเดทปุ่ม submit
                  document.getElementById('submitPresentation').innerHTML = `<i class="fas fa-paper-plane"></i> ส่งเอกสารนำเสนอ (${file.name})`;
                  
                  // ซ่อน progress bar
                  setTimeout(() => {
                    document.getElementById('presentationProgress').style.display = 'none';
                  }, 500);
                }
              }, 50);
            });
          }
          
          // ปุ่มส่งเอกสารนำเสนอ
          const submitButton = document.getElementById('submitPresentation');
          if (submitButton) {
            submitButton.addEventListener('click', function() {
              const fileInput = document.getElementById('presentationFile');
              
              if (!fileInput.files || fileInput.files.length === 0) {
                showAlert('ไม่พบไฟล์', 'กรุณาเลือกไฟล์ที่ต้องการอัปโหลด', 'warning');
                return;
              }
              
              const file = fileInput.files[0];
              
              // แสดง loading
              loadingOverlay.classList.add('show');
              
              // ส่งไฟล์ไปยัง API
              uploadPresentationFile(authToken, file)
                .then(response => {
                  if (response.success) {
                    showAlert('สำเร็จ', 'อัปโหลดเอกสารนำเสนอเรียบร้อยแล้ว', 'success');
                    
                    // Refresh หน้าเพื่อแสดงข้อมูลล่าสุด
                    setTimeout(() => {
                      window.location.reload();
                    }, 1500);
                  } else {
                    throw new Error(response.message || 'ไม่สามารถอัปโหลดไฟล์ได้');
                  }
                })
                .catch(error => {
                  console.error('Upload error:', error);
                  showAlert('เกิดข้อผิดพลาด', error.message, 'danger');
                  loadingOverlay.classList.remove('show');
                });
            });
          }
          
          // ********** Functions **********
          // Fixed updateLoginState function with proper dropdown structure
          function updateLoginState(isLoggedIn, userData = null) {
            const loginMenuItem = document.getElementById('loginMenuItem');
            
            if (!loginMenuItem) return;
            
            if (isLoggedIn && userData) {
              // Use proper Bootstrap dropdown structure
              loginMenuItem.className = 'nav-item dropdown';
              loginMenuItem.innerHTML = `
                <a class="nav-link dropdown-toggle btn btn-login" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fas fa-user-circle me-1"></i> ${userData.username}
                </a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                  <li><a class="dropdown-item" href="/sims/profile"><i class="fas fa-id-card me-2"></i>โปรไฟล์</a></li>
                  <li><a class="dropdown-item" href="/sims/proposals"><i class="fas fa-file-alt me-2"></i>โครงการของฉัน</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item text-danger" href="/sims/logout"><i class="fas fa-sign-out-alt me-2"></i>ออกจากระบบ</a></li>
                </ul>
              `;
            }
          }
    
          // Function สำหรับ logout
          window.handleLogout = function(e) {
            e.preventDefault();
            if (confirm('ต้องการออกจากระบบหรือไม่?')) {
              localStorage.removeItem('authToken');
              localStorage.removeItem('userData');
              
              // ใช้ showAlert ถ้ามี
              if (typeof showAlert === 'function') {
                showAlert('ออกจากระบบสำเร็จ', 'คุณได้ออกจากระบบเรียบร้อยแล้ว', 'success');
              } else {
                alert('ออกจากระบบสำเร็จ');
              }
              
              setTimeout(() => {
                window.location.href = '/sims/login';
              }, 1500);
            }
          }
          
          // ฟังก์ชั่นตรวจสอบ Token
          async function validateToken(token) {
            try {
              const response = await fetch('https://adicet.cmru.ac.th/node/api/auth/validate', {
                method: 'GET',
                headers: {
                  'Authorization': `Bearer ${token}`
                }
              });
              
              return await response.json();
            } catch (error) {
              console.error('Error validating token:', error);
              return { success: false, message: 'เกิดข้อผิดพลาดในการตรวจสอบ Token' };
            }
          }
          
          // ฟังก์ชั่นดึงข้อมูลโครงการ
          async function getProposalData(token) {
            try {
              const response = await fetch('https://adicet.cmru.ac.th/node/api/getmyproposal', {
                method: 'GET',
                headers: {
                  'Authorization': `Bearer ${token}`
                }
              });
              
              if (!response.ok) {
                throw new Error('Network response was not ok');
              }
              
              return await response.json();
            } catch (error) {
              console.error('Error fetching proposal data:', error);
              throw new Error('ไม่สามารถดึงข้อมูลโครงการได้');
            }
          }
          
          // ฟังก์ชั่นอัปโหลดไฟล์นำเสนอ
          async function uploadPresentationFile(token, file) {
            try {
              // ดึง proposal ID จากข้อมูลปัจจุบัน
              const proposalData = await getProposalData(token);
              if (!proposalData.success || !proposalData.proposal) {
                throw new Error('ไม่พบข้อมูลโครงการ');
              }
              
              const proposalId = proposalData.proposal.id;
              
              const formData = new FormData();
              formData.append('presentationFile', file);
              
              const response = await fetch(`https://adicet.cmru.ac.th/node/api/proposals/${proposalId}/presentation`, {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${token}`
                },
                body: formData
              });
              
              return await response.json();
            } catch (error) {
              console.error('Error uploading file:', error);
              throw new Error('ไม่สามารถอัปโหลดไฟล์ได้');
            }
          }
          
          // ฟังก์ชั่นอัพเดทข้อมูลโครงการ
          function updateProposalInfo(data) {
            const proposal = data.proposal;
            
            // ตั้งค่าข้อมูลพื้นฐานของโครงการ
            document.getElementById('referenceNumber').textContent = proposal.proposals_id || '-';
            document.getElementById('projectTitle').textContent = proposal.project_title || '-';
            document.getElementById('innovationType').textContent = proposal.innovation_type || '-';
            document.getElementById('projectProvince').textContent = proposal.province || '-';
            document.getElementById('requestedBudget').textContent = proposal.budget_requested ? `${parseFloat(proposal.budget_requested).toLocaleString()} บาท` : '-';
            document.getElementById('beneficiaries').textContent = proposal.beneficiaries ? `${parseInt(proposal.beneficiaries).toLocaleString()} คน` : '-';
            
            // ตั้งค่าวันที่ส่งโครงการ
            const submissionDate = proposal.created_at ? new Date(proposal.created_at) : null;
            document.getElementById('submissionDate').textContent = submissionDate ? formatDate(submissionDate) : '-';
            
            // คำนวณระยะเวลาดำเนินการ
            const projectDuration = calculateProjectDuration(submissionDate);
            document.getElementById('projectDuration').textContent = projectDuration;
            
            // ตั้งค่าวันที่อัปโหลดเอกสาร
            document.getElementById('wordUploadDate').textContent = submissionDate ? formatDate(submissionDate) : '-';
            document.getElementById('pdfUploadDate').textContent = submissionDate ? formatDate(submissionDate) : '-';
            document.getElementById('businessUploadDate').textContent = submissionDate ? formatDate(submissionDate) : '-';
            
            // เปิดใช้งานปุ่มดาวน์โหลดถ้ามีไฟล์
            if (proposal.word_file_path) {
              document.getElementById('downloadWordBtn').disabled = false;
            }
            if (proposal.pdf_file_path) {
              document.getElementById('downloadPdfBtn').disabled = false;
            }
            if (proposal.business_file_path) {
              document.getElementById('downloadBusinessBtn').disabled = false;
            }
            
            // ตั้งค่าขั้นตอนถัดไป
            setNextStep(proposal.status);
          }
          
          // ฟังก์ชั่นคำนวณระยะเวลาดำเนินการ
          function calculateProjectDuration(submissionDate) {
            if (!submissionDate) return '-';
            
            const currentDate = new Date();
            const diffTime = Math.abs(currentDate - submissionDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
              return 'วันนี้';
            } else if (diffDays === 1) {
              return '1 วัน';
            } else {
              return `${diffDays} วัน`;
            }
          }
          
          // ฟังก์ชั่นอัพเดทสถานะ UI (ปรับปรุงให้ไม่แสดงสถานะ rejected แยก)
          function updateStatusUI(status) {
            // กำหนดข้อความและไอคอนตามสถานะ
            const statusTitles = {
              'waiting': 'รอการตรวจรับ',
              'reviewing': 'เจ้าหน้าที่ตรวจรับแล้ว รอการรับรองให้นำเสนอผลงาน',
              'preparing': 'เตรียมข้อมูลสำหรับการนำเสนอ',
              'approved': 'อนุมัติโครงการ',
              'rejected': 'ไม่ผ่านการอนุมัติ'
            };
            
            const statusIcons = {
              'waiting': 'fas fa-hourglass-half',
              'reviewing': 'fas fa-clipboard-check',
              'preparing': 'fas fa-laptop-code',
              'approved': 'fas fa-check-circle',
              'rejected': 'fas fa-times-circle'
            };
            
            const statusDescriptions = {
              'waiting': 'โครงการของคุณกำลังอยู่ในขั้นตอนการตรวจรับโดยเจ้าหน้าที่ กรุณารอการติดต่อกลับภายใน 7-14 วันทำการ',
              'reviewing': 'เจ้าหน้าที่ได้ตรวจรับโครงการของคุณเรียบร้อยแล้ว และอยู่ระหว่างการพิจารณาเพื่อนำเสนอต่อคณะกรรมการ',
              'preparing': 'โครงการของคุณได้รับการคัดเลือกให้นำเสนอต่อคณะกรรมการ กรุณาเตรียมข้อมูลสำหรับการนำเสนอตามแบบฟอร์มที่กำหนด',
              'approved': 'ยินดีด้วย! โครงการของคุณได้รับการอนุมัติเรียบร้อยแล้ว ท่านจะได้รับการติดต่อเพื่อดำเนินการในขั้นตอนต่อไป',
              'rejected': 'ขออภัย โครงการของคุณไม่ผ่านการอนุมัติในครั้งนี้ กรุณาตรวจสอบข้อเสนอแนะจากคณะกรรมการด้านล่าง'
            };
            
            // อัพเดทการ์ดสถานะปัจจุบัน
            const currentStatusCard = document.getElementById('currentStatusCard');
            currentStatusCard.className = 'current-status-card';
            currentStatusCard.classList.add(`status-${status}`);
            
            document.getElementById('statusTitle').innerHTML = `<i class="${statusIcons[status] || 'fas fa-circle'}"></i> ${statusTitles[status] || 'สถานะไม่ทราบ'}`;
            document.getElementById('statusDescription').textContent = statusDescriptions[status] || 'กำลังประมวลผลสถานะ...';
            
            // อัพเดท status tracker
            const statusItems = document.querySelectorAll('.status-item');
            statusItems.forEach(item => {
              item.classList.remove('active', 'completed');
            });
            
            let progress = 0;
            
            // กรณีปกติ รวมถึง rejected จะแสดงผลที่ approved แทน
            const statusOrder = ['waiting', 'reviewing', 'preparing', 'approved'];
            let displayStatus = status;
            
            // ถ้าเป็น rejected จะถือว่าเป็นผลของ approved ที่ไม่ผ่าน
            if (status === 'rejected') {
              displayStatus = 'approved';
            }
            
            const currentIndex = statusOrder.indexOf(displayStatus);
            
            if (currentIndex !== -1) {
              // มาร์คขั้นตอนก่อนหน้าเป็น completed
              for (let i = 0; i < currentIndex; i++) {
                const item = document.querySelector(`[data-status="${statusOrder[i]}"]`);
                if (item) item.classList.add('completed');
              }
              
              // มาร์คขั้นตอนปัจจุบันเป็น active
              const currentItem = document.querySelector(`[data-status="${displayStatus}"]`);
              if (currentItem) currentItem.classList.add('active');
              
              // ถ้าเป็น rejected ให้เปลี่ยนไอคอนและสี
              if (status === 'rejected' && currentItem) {
                const icon = currentItem.querySelector('.status-icon i');
                if (icon) {
                  icon.className = 'fas fa-times-circle';
                }
                currentItem.querySelector('.status-icon').style.backgroundColor = 'var(--status-rejected)';
                currentItem.querySelector('.status-text').textContent = 'ไม่ผ่านการอนุมัติ';
                currentItem.querySelector('.status-text').style.color = 'var(--status-rejected)';
              }
              
              // คำนวณเปอร์เซ็นต์ความก้าวหน้า
              progress = (currentIndex / (statusOrder.length - 1)) * 100;
            }
            
            // อัพเดท progress bar
            const progressBar = document.getElementById('statusProgressBar');
            if (progressBar) {
              progressBar.style.width = `${progress}%`;
            }
            
            // อัพเดทปุ่มดำเนินการ
            updateActionButtons(status);
          }
          
          // ฟังก์ชั่นอัพเดทปุ่มดำเนินการ
          function updateActionButtons(status) {
            const container = document.getElementById('actionButtonsContainer');
            container.innerHTML = '';
            
            // กำหนดปุ่มตามสถานะ
            const buttons = {
              'waiting': [
                { 
                  text: 'ติดตามสถานะ', 
                  icon: 'fas fa-sync-alt', 
                  class: 'btn-warning', 
                  action: 'checkStatus' 
                }
              ],
              'reviewing': [
                { 
                  text: 'ติดตามสถานะ', 
                  icon: 'fas fa-sync-alt', 
                  class: 'btn-primary', 
                  action: 'checkStatus' 
                }
              ],
              'preparing': [
                { 
                  text: 'ดาวน์โหลดแบบฟอร์มนำเสนอ', 
                  icon: 'fas fa-download', 
                  class: 'btn-info', 
                  action: 'downloadTemplate' 
                },
                { 
                  text: 'อัพโหลดข้อมูลนำเสนอ', 
                  icon: 'fas fa-upload', 
                  class: 'btn-primary', 
                  action: 'uploadPresentation' 
                }
              ],
              'approved': [
                { 
                  text: 'ดาวน์โหลดหนังสือรับรอง', 
                  icon: 'fas fa-certificate', 
                  class: 'btn-success', 
                  action: 'downloadCertificate' 
                },
                { 
                  text: 'จัดการโครงการ', 
                  icon: 'fas fa-tasks', 
                  class: 'btn-primary', 
                  action: 'manageProject' 
                }
              ],
              'rejected': [
                { 
                  text: 'ดูรายละเอียดการประเมิน', 
                  icon: 'fas fa-clipboard-list', 
                  class: 'btn-danger', 
                  action: 'viewFeedback' 
                },
                { 
                  text: 'ส่งข้อเสนอใหม่', 
                  icon: 'fas fa-redo', 
                  class: 'btn-primary', 
                  action: 'resubmit' 
                }
              ]
            };
            
            // สร้างปุ่มตามสถานะ
            if (buttons[status]) {
              buttons[status].forEach(button => {
                const btn = document.createElement('button');
                btn.className = `btn btn-action ${button.class}`;
                btn.innerHTML = `<i class="${button.icon}"></i> ${button.text}`;
                btn.setAttribute('data-action', button.action);
                btn.addEventListener('click', handleActionButtonClick);
                container.appendChild(btn);
              });
            }
          }
          
          // ฟังก์ชั่นจัดการการคลิกปุ่มดำเนินการ
          function handleActionButtonClick(e) {
            const action = e.currentTarget.getAttribute('data-action');
            
            switch(action) {
              case 'checkStatus':
                // Refresh หน้าเพื่อตรวจสอบสถานะล่าสุด
                window.location.reload();
                break;
                
              case 'downloadTemplate':
                // ดาวน์โหลดแบบฟอร์มนำเสนอ
                window.location.href = '/sidfile/templates/presentation_template.pptx';
                break;
                
              case 'uploadPresentation':
                // เลื่อนไปยังส่วนอัปโหลดไฟล์
                document.getElementById('uploadSection').scrollIntoView({ behavior: 'smooth' });
                break;
                
              case 'downloadCertificate':
                // ดาวน์โหลดหนังสือรับรอง
                showAlert('แจ้งเตือน', 'หนังสือรับรองจะพร้อมให้ดาวน์โหลดในอีก 3-5 วันทำการ', 'info');
                break;
                
              case 'manageProject':
                // ไปยังหน้าจัดการโครงการ
                showAlert('แจ้งเตือน', 'ระบบจัดการโครงการจะเปิดให้ใช้งานเร็วๆ นี้', 'info');
                break;
                
              case 'viewFeedback':
                // เลื่อนไปยังส่วนข้อเสนอแนะ
                document.getElementById('feedbackSection').scrollIntoView({ behavior: 'smooth' });
                break;
                
              case 'resubmit':
                // ไปยังหน้าส่งข้อเสนอใหม่
                if (confirm('คุณต้องการส่งข้อเสนอโครงการใหม่หรือไม่?')) {
                  window.location.href = '/sims/submit';
                }
                break;
                
              default:
                showAlert('แจ้งเตือน', 'ฟังก์ชันนี้อยู่ระหว่างการพัฒนา', 'info');
            }
          }
          
          // ฟังก์ชั่นอัพเดทไทม์ไลน์
          function updateTimeline(statusHistory) {
            const timeline = document.getElementById('projectTimeline');
            timeline.innerHTML = '';
            
            if (!statusHistory || statusHistory.length === 0) {
              // กรณีไม่มีประวัติ - สร้างประวัติเริ่มต้น
              const defaultHistory = [{
                status: 'waiting',
                status_date: new Date().toISOString(),
                remarks: 'ส่งข้อเสนอโครงการเรียบร้อยแล้ว กำลังรอการตรวจรับโดยเจ้าหน้าที่',
                updated_by_name: 'ระบบ'
              }];
              
              defaultHistory.forEach(item => {
                const timelineItem = createTimelineItem(
                  item.status,
                  formatDate(new Date(item.status_date)),
                  item.remarks,
                  item.updated_by_name
                );
                timeline.appendChild(timelineItem);
              });
              return;
            }
            
            // เรียงลำดับจากเก่าไปใหม่ (จากล่างขึ้นบน)
            statusHistory.sort((a, b) => new Date(a.status_date) - new Date(b.status_date));
            
            // สร้าง timeline items
            statusHistory.forEach(item => {
              const timelineItem = createTimelineItem(
                item.status,
                formatDate(new Date(item.status_date)),
                item.remarks || getStatusMessage(item.status),
                item.updated_by_name || 'ระบบ'
              );
              timeline.appendChild(timelineItem);
            });
          }
          
          // ฟังก์ชั่นสร้าง timeline item
          function createTimelineItem(status, date, message, updatedBy) {
            const item = document.createElement('div');
            item.className = 'timeline-item';
            
            // กำหนดไอคอนตามสถานะ
            const statusIcons = {
              'waiting': 'fas fa-hourglass-half',
              'reviewing': 'fas fa-clipboard-check',
              'preparing': 'fas fa-laptop-code',
              'approved': 'fas fa-check-circle',
              'rejected': 'fas fa-times-circle'
            };
            
            item.innerHTML = `
              <div class="timeline-icon ${status}">
                <i class="${statusIcons[status] || 'fas fa-circle'}"></i>
              </div>
              <div class="timeline-date">${date}</div>
              <div class="timeline-content">
                <p class="mb-0">${message}</p>
                <small class="text-muted">โดย: ${updatedBy}</small>
              </div>
            `;
            
            return item;
          }
          
          // ฟังก์ชั่นอัพเดทการแจ้งเตือน
          function updateNotifications(notifications) {
            const container = document.getElementById('notificationsContainer');
            container.innerHTML = '';
            
            if (!notifications || notifications.length === 0) {
              // กรณีไม่มีการแจ้งเตือน
              const noNotifMsg = document.createElement('p');
              noNotifMsg.className = 'text-muted text-center';
              noNotifMsg.textContent = 'ไม่มีการแจ้งเตือน';
              container.appendChild(noNotifMsg);
              return;
            }
            
            // เรียงลำดับจากใหม่ไปเก่า
            notifications.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            // สร้าง notification cards
            notifications.forEach(notif => {
              const notifCard = document.createElement('div');
              notifCard.className = `notification-card ${notif.is_read ? '' : 'unread'}`;
              notifCard.setAttribute('data-id', notif.id);
              
              notifCard.innerHTML = `
                <div class="notification-title">
                  <span>${getNotificationTitle(notif.status)}</span>
                  <span class="notification-time">${formatDateShort(new Date(notif.created_at))}</span>
                </div>
                <div class="notification-content">${notif.message}</div>
              `;
              
              // เพิ่ม event listener สำหรับการคลิกเพื่อทำเครื่องหมายว่าอ่านแล้ว
              notifCard.addEventListener('click', function() {
                if (!notif.is_read) {
                  markNotificationAsRead(notif.id);
                  notifCard.classList.remove('unread');
                  notif.is_read = true;
                }
              });
              
              container.appendChild(notifCard);
            });
          }
          
          // ฟังก์ชั่นทำเครื่องหมายว่าอ่านแล้ว
          async function markNotificationAsRead(notificationId) {
            try {
              const response = await fetch(`https://adicet.cmru.ac.th/node/api/notifications/read/${notificationId}`, {
                method: 'PUT',
                headers: {
                  'Authorization': `Bearer ${authToken}`,
                  'Content-Type': 'application/json'
                }
              });
              
              const result = await response.json();
              if (!result.success) {
                console.error('Error marking notification as read:', result.message);
              }
            } catch (error) {
              console.error('Error marking notification as read:', error);
            }
          }
          
          // ฟังก์ชั่นแสดง/ซ่อนส่วนต่างๆ ตามสถานะ
          function toggleSectionsByStatus(status, data) {
            // ส่วนอัปโหลดไฟล์ (แสดงเฉพาะเมื่อสถานะเป็น preparing)
            const uploadSection = document.getElementById('uploadSection');
            if (uploadSection) {
              uploadSection.style.display = status === 'preparing' ? 'block' : 'none';
            }
            
            // ส่วนข้อเสนอแนะ (แสดงเฉพาะเมื่อสถานะเป็น rejected)
            const feedbackSection = document.getElementById('feedbackSection');
            if (feedbackSection) {
              feedbackSection.style.display = status === 'rejected' ? 'block' : 'none';
              
              // แสดงข้อเสนอแนะหากมี
              if (status === 'rejected' && data.feedback) {
                document.getElementById('feedbackContent').innerHTML = data.feedback.feedback.replace(/\n/g, '<br>');
              }
            }
          }
          
          // ฟังก์ชั่นตั้งค่าขั้นตอนถัดไป
          function setNextStep(status) {
            const nextStepBadge = document.getElementById('nextStepBadge');
            const nextStepText = document.getElementById('nextStep');
            
            switch(status) {
              case 'waiting':
                nextStepText.textContent = 'รอการตรวจรับโดยเจ้าหน้าที่';
                break;
              case 'reviewing':
                nextStepText.textContent = 'รอการรับรองให้นำเสนอผลงาน';
                break;
              case 'preparing':
                nextStepText.textContent = 'อัปโหลดเอกสารนำเสนอ';
                break;
              case 'approved':
                nextStepText.textContent = 'ติดต่อเจ้าหน้าที่เพื่อทำสัญญา';
                break;
              case 'rejected':
                nextStepText.textContent = 'ปรับปรุงโครงการตามข้อเสนอแนะ';
                nextStepBadge.classList.remove('badge-glow');
                break;
              default:
                nextStepText.textContent = 'ติดต่อเจ้าหน้าที่';
            }
          }
          
          // ฟังก์ชั่นดาวน์โหลดเอกสาร
          function downloadDocument(type) {
            // ดึงข้อมูลเส้นทางไฟล์จากข้อมูล proposal
            getProposalData(authToken).then(data => {
              if (data.success) {
                const proposal = data.proposal;
                const paths = {
                  'word': proposal.word_file_path,
                  'pdf': proposal.pdf_file_path,
                  'business': proposal.business_file_path
                };
                
                if (paths[type]) {
                  window.location.href = paths[type];
                } else {
                  showAlert('ไม่พบไฟล์', 'ไม่พบไฟล์ที่ต้องการดาวน์โหลด', 'warning');
                }
              }
            }).catch(error => {
              console.error('Error downloading document:', error);
              showAlert('เกิดข้อผิดพลาด', 'ไม่สามารถดาวน์โหลดไฟล์ได้', 'danger');
            });
          }
          
          // ฟังก์ชั่นแสดง Alert
          function showAlert(title, message, type = 'success') {
            const alertBox = document.getElementById('alertBox');
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;
            
            // เปลี่ยนประเภท alert
            const alertElement = alertBox.querySelector('.alert');
            alertElement.className = `alert alert-${type} alert-dismissible fade show`;
            
            // แสดง alert
            alertBox.classList.add('show');
            
            // ซ่อนอัตโนมัติหลัง 5 วินาที
            setTimeout(() => {
              alertBox.classList.remove('show');
            }, 5000);
          }
          
          // ฟังก์ชั่นจัดรูปแบบวันที่
          function formatDate(date) {
            return new Intl.DateTimeFormat('th-TH', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric'
            }).format(date);
          }
          
          // ฟังก์ชั่นจัดรูปแบบวันที่แบบย่อ
          function formatDateShort(date) {
            return new Intl.DateTimeFormat('th-TH', {
              day: '2-digit',
              month: 'short',
              year: 'numeric'
            }).format(date);
          }
          
          // ฟังก์ชั่นดึงข้อความตามสถานะ
          function getStatusMessage(status) {
            const messages = {
              'waiting': 'ส่งข้อเสนอโครงการเรียบร้อยแล้ว กำลังรอการตรวจรับโดยเจ้าหน้าที่',
              'reviewing': 'เจ้าหน้าที่ได้ตรวจรับโครงการเรียบร้อยแล้ว และอยู่ระหว่างการพิจารณาเพื่อนำเสนอต่อคณะกรรมการ',
              'preparing': 'โครงการได้รับการคัดเลือกให้นำเสนอต่อคณะกรรมการ กรุณาเตรียมข้อมูลสำหรับการนำเสนอ',
              'approved': 'โครงการได้รับการอนุมัติเรียบร้อยแล้ว',
              'rejected': 'โครงการไม่ผ่านการอนุมัติในครั้งนี้'
            };
            
            return messages[status] || 'มีการอัพเดทสถานะโครงการ';
          }
          
          // ฟังก์ชั่นดึงหัวข้อการแจ้งเตือนตามสถานะ
          function getNotificationTitle(status) {
            const titles = {
              'waiting': 'รอการตรวจรับ',
              'reviewing': 'เจ้าหน้าที่ตรวจรับแล้ว',
              'preparing': 'เตรียมข้อมูลนำเสนอ',
              'approved': 'โครงการได้รับการอนุมัติ',
              'rejected': 'โครงการไม่ผ่านการอนุมัติ'
            };
            
            return titles[status] || 'การแจ้งเตือนใหม่';
          }
        });
      </script>
    </body>
</html>
