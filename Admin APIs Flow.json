[
    {
        "id": "0ae7375ee0dd9a25",
        "type": "tab",
        "label": "Admin APIs Flow",
        "disabled": false,
        "info": "Node-RED flow ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin APIs",
        "env": []
    },
    {
        "id": "d1201243cd68909c",
        "type": "function",
        "z": "0ae7375ee0dd9a25",
        "name": "Check Admin Token",
        "func": "// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Authorization header\nconst authHeader = msg.req.headers.authorization;\n\nif (!authHeader || !authHeader.startsWith('Bearer ')) {\n    msg.statusCode = 401;\n    msg.payload = {\n        success: false,\n        error: \"Token missing\"\n    };\n    return [null, msg]; // output ‡∏ó‡∏µ‡πà 2 = error\n}\n\n// ‡∏î‡∏∂‡∏á token\nmsg.token = authHeader.split(' ')[1];\n\nreturn [msg, null]; // output ‡∏ó‡∏µ‡πà 1 = success",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 450,
        "y": 640,
        "wires": [
            [
                "7cd746e9699de1c9"
            ],
            [
                "47f0ea251a16cbff"
            ]
        ]
    },
    {
        "id": "acd2ed4acb06b09e",
        "type": "http in",
        "z": "0ae7375ee0dd9a25",
        "name": "Change Status to Preparing",
        "url": "/api/admin/proposals/:id/prepare",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 200,
        "y": 480,
        "wires": [
            [
                "d1201243cd68909c"
            ]
        ]
    },
    {
        "id": "c16c593cc118a6f4",
        "type": "http in",
        "z": "0ae7375ee0dd9a25",
        "name": "Final Approve",
        "url": "/api/admin/proposals/:id/approve",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 170,
        "y": 520,
        "wires": [
            [
                "d1201243cd68909c"
            ]
        ]
    },
    {
        "id": "04dcd4f8f8831724",
        "type": "http in",
        "z": "0ae7375ee0dd9a25",
        "name": "Reject Proposal",
        "url": "/api/admin/proposals/:id/reject",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 180,
        "y": 640,
        "wires": [
            [
                "d1201243cd68909c"
            ]
        ]
    },
    {
        "id": "c2d043770d473541",
        "type": "http in",
        "z": "0ae7375ee0dd9a25",
        "name": "Review Proposal",
        "url": "/api/admin/proposals/:id/review",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 180,
        "y": 680,
        "wires": [
            [
                "d1201243cd68909c"
            ]
        ]
    },
    {
        "id": "d168f5e70980b627",
        "type": "http in",
        "z": "0ae7375ee0dd9a25",
        "name": "Conditional Approval",
        "url": "/api/admin/proposals/:id/conditional-approval",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 190,
        "y": 720,
        "wires": [
            [
                "d1201243cd68909c"
            ]
        ]
    },
    {
        "id": "e859db54281c4f9c",
        "type": "http in",
        "z": "0ae7375ee0dd9a25",
        "name": "Get All Proposals",
        "url": "/api/admin/proposals",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 180,
        "y": 800,
        "wires": [
            [
                "d1201243cd68909c"
            ]
        ]
    },
    {
        "id": "cf9ea7108ecc1ace",
        "type": "http in",
        "z": "0ae7375ee0dd9a25",
        "name": "Final Approve (Explicit)",
        "url": "/api/admin/proposals/:id/final-approve",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 200,
        "y": 560,
        "wires": [
            [
                "d1201243cd68909c"
            ]
        ]
    },
    {
        "id": "7cd746e9699de1c9",
        "type": "jwt verify",
        "z": "0ae7375ee0dd9a25",
        "name": "Verify Admin JWT",
        "alg": [
            "HS256"
        ],
        "jwkurl": "",
        "secret": "Superadicet!",
        "key": "",
        "signvar": "token",
        "storetoken": "payload",
        "x": 650,
        "y": 580,
        "wires": [
            [
                "43f9eb5d5d4cd84c"
            ]
        ]
    },
    {
        "id": "47f0ea251a16cbff",
        "type": "http response",
        "z": "0ae7375ee0dd9a25",
        "name": "HTTP Response",
        "statusCode": "",
        "headers": {
            "Content-Type": "application/json",
            "Access-Control-Allow-Origin": "*",
            "Access-Control-Allow-Headers": "Origin, X-Requested-With, Content-Type, Accept, Authorization",
            "Access-Control-Allow-Methods": "GET, POST, OPTIONS"
        },
        "x": 2320,
        "y": 940,
        "wires": []
    },
    {
        "id": "43f9eb5d5d4cd84c",
        "type": "function",
        "z": "0ae7375ee0dd9a25",
        "name": "Check Admin Role & Route",
        "func": "// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô admin ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà\nif (!msg.payload || msg.payload.role !== 'admin') {\n    msg.statusCode = 403;\n    msg.payload = {\n        success: false,\n        error: \"‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á\"\n    };\n    return [null, msg]; // output ‡∏ó‡∏µ‡πà 2 = error\n}\n\n// ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• user\nmsg.admin = msg.payload;\n\n// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô GET request ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö list ‡∏´‡∏£‡∏∑‡∏≠ POST request ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö change status\nif (msg.req.method === 'GET' && msg.req.url === '/api/admin/proposals') {\n    // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á List Proposals Query\n    return [null, null, msg];\n} else {\n    // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞\n    msg.proposalId = msg.req.params.id;\n    \n    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏° path\n    const path = msg.req.originalUrl;\n    if (path.includes('/prepare')) {\n        msg.newStatus = 'preparing';\n    } else if (path.includes('/final-approve')) {\n        msg.newStatus = 'approved';\n    } else if (path.includes('/approve')) {\n        msg.newStatus = 'approved';\n    } else if (path.includes('/reject')) {\n        msg.newStatus = 'rejected';\n        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö reject ‡∏î‡∏∂‡∏á reason ‡πÅ‡∏•‡∏∞ feedback\n        if (msg.req.body.reason) {\n            msg.rejectReason = msg.req.body.reason;\n            msg.rejectFeedback = msg.req.body.feedback || '';\n            // ‡∏™‡∏£‡πâ‡∏≤‡∏á remarks ‡∏à‡∏≤‡∏Å reason ‡πÅ‡∏•‡∏∞ feedback\n            const reasonText = getReasonText(msg.rejectReason);\n            msg.remarks = `‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${reasonText}\\n\\n‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${msg.rejectFeedback}`;\n        } else {\n            // ‡∏ñ‡πâ‡∏≤‡∏™‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô remarks ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á\n            msg.remarks = msg.req.body.remarks || '';\n        }\n    } else if (path.includes('/review')) {\n        msg.newStatus = 'reviewing';\n    } else if (path.includes('/conditional-approval')) {\n        // Conditional approval\n        msg.newStatus = msg.req.body.requiresModification ? 'waiting_revision' : 'reviewing';\n        msg.conditionalFeedback = msg.req.body.feedback || '';\n        msg.requiresModification = msg.req.body.requiresModification || false;\n        msg.remarks = msg.req.body.requiresModification ? \n            `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ${msg.conditionalFeedback}` : \n            `‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞: ${msg.conditionalFeedback}`;\n    }\n    \n    // ‡πÄ‡∏Å‡πá‡∏ö remarks ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö status ‡∏≠‡∏∑‡πà‡∏ô‡πÜ)\n    if (!msg.remarks) {\n        msg.remarks = msg.req.body.remarks || '';\n    }\n    \n    return [msg, null, null];\n}\n\n// Helper function ‡πÅ‡∏õ‡∏•‡∏á reason code\nfunction getReasonText(reason) {\n    const reasons = {\n        'incomplete_info': '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',\n        'not_aligned': '‡πÑ‡∏°‡πà‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå',\n        'budget_issue': '‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°',\n        'duplicate': '‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà',\n        'not_feasible': '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á',\n        'other': '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'\n    };\n    return reasons[reason] || reason;\n}",
        "outputs": 3,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 870,
        "y": 620,
        "wires": [
            [
                "8dddc4a66720ca45"
            ],
            [
                "47f0ea251a16cbff"
            ],
            [
                "7329fd0a576b1aa8"
            ]
        ]
    },
    {
        "id": "ce300c711d09de2e",
        "type": "function",
        "z": "0ae7375ee0dd9a25",
        "name": "Validate Proposal & Transitions",
        "func": "// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏û‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà\nif (!msg.payload || msg.payload.length === 0) {\n    msg.statusCode = 404;\n    msg.payload = {\n        success: false,\n        error: \"‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏\"\n    };\n    return [null, msg]; // output ‡∏ó‡∏µ‡πà 2 = error\n}\n\nconst proposal = msg.payload[0];\nmsg.currentProposal = proposal;\n\n// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á\nconst validTransitions = {\n    'waiting': ['reviewing', 'waiting_revision', 'rejected'],\n    'waiting_revision': ['reviewing', 'rejected'],\n    'reviewing': ['preparing', 'rejected', 'waiting_revision'],\n    'preparing': ['approved', 'rejected'],\n    'rejected': [],\n    'approved': []\n};\n\n// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà\nconst currentStatus = proposal.status;\nconst allowedStatuses = validTransitions[currentStatus] || [];\n\nif (!allowedStatuses.includes(msg.newStatus)) {\n    msg.statusCode = 400;\n    msg.payload = {\n        success: false,\n        error: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å ${currentStatus} ‡πÄ‡∏õ‡πá‡∏ô ${msg.newStatus} ‡πÑ‡∏î‡πâ`,\n        currentStatus: currentStatus,\n        newStatus: msg.newStatus,\n        allowedTransitions: allowedStatuses\n    };\n    return [null, msg]; // output ‡∏ó‡∏µ‡πà 2 = error\n}\n\nreturn [msg, null]; // output ‡∏ó‡∏µ‡πà 1 = success",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1560,
        "y": 580,
        "wires": [
            [
                "ae79c69f33f0198d"
            ],
            [
                "47f0ea251a16cbff"
            ]
        ]
    },
    {
        "id": "be4ac82f3d9375f9",
        "type": "function",
        "z": "0ae7375ee0dd9a25",
        "name": "Success Response",
        "func": "// ‡∏™‡∏£‡πâ‡∏≤‡∏á response message ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞\nconst statusMessages = {\n    'waiting': '‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö',\n    'reviewing': '‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',\n    'waiting_revision': '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',\n    'preparing': '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',\n    'approved': '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',\n    'rejected': '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'\n};\n\nmsg.statusCode = 200;\nmsg.payload = {\n    success: true,\n    message: statusMessages[msg.newStatus] || `‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô ${msg.newStatus} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,\n    proposalId: msg.proposalId,\n    newStatus: msg.newStatus,\n    remarks: msg.remarks || ''\n};\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1740,
        "y": 1080,
        "wires": [
            [
                "47f0ea251a16cbff"
            ]
        ]
    },
    {
        "id": "faa81501fe4a7e54",
        "type": "function",
        "z": "0ae7375ee0dd9a25",
        "name": "Format Proposals List",
        "func": "// ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£\nconst proposals = msg.payload.map(proposal => ({\n    id: proposal.id,\n    proposalId: proposal.proposals_id,\n    title: proposal.project_title,\n    innovationType: proposal.innovation_type,\n    status: proposal.status,\n    leadName: proposal.lead_name,\n    leadEmail: proposal.lead_email,\n    username: proposal.lead_username,\n    budget: proposal.budget_requested,\n    beneficiaries: proposal.beneficiaries,\n    province: proposal.province,\n    createdAt: proposal.created_at,\n    updatedAt: proposal.updated_at\n}));\n\nmsg.statusCode = 200;\nmsg.payload = {\n    success: true,\n    message: \"‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß\",\n    total: proposals.length,\n    proposals: proposals\n};\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1330,
        "y": 1120,
        "wires": [
            [
                "47f0ea251a16cbff"
            ]
        ]
    },
    {
        "id": "119a01eaac3d4ea9",
        "type": "function",
        "z": "0ae7375ee0dd9a25",
        "name": "JWT Error Response",
        "func": "let errorMessage = \"Token ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á\";\nlet errorCode = \"INVALID_TOKEN\";\n\nif (msg.error && msg.error.message) {\n    if (msg.error.message.includes('expired')) {\n        errorMessage = \"Token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà\";\n        errorCode = \"TOKEN_EXPIRED\";\n    }\n}\n\nmsg.statusCode = 401;\nmsg.payload = {\n    success: false,\n    error: errorMessage,\n    code: errorCode\n};\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 700,
        "y": 740,
        "wires": [
            [
                "47f0ea251a16cbff"
            ]
        ]
    },
    {
        "id": "8dddc4a66720ca45",
        "type": "function",
        "z": "0ae7375ee0dd9a25",
        "name": "Prepare Proposal Query",
        "func": "// ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° SQL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô\nmsg.topic = \"SELECT * FROM proposals WHERE id = ?\";\nmsg.payload = [msg.proposalId];\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1140,
        "y": 580,
        "wires": [
            [
                "5cfae82beb71b3cf"
            ]
        ]
    },
    {
        "id": "7329fd0a576b1aa8",
        "type": "function",
        "z": "0ae7375ee0dd9a25",
        "name": "List Proposals Query",
        "func": "// ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö admin proposal list\n// ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î\nlet query = `\n    SELECT \n        p.*,\n        u.username as lead_username,\n        u.email as lead_user_email\n    FROM proposals p\n    LEFT JOIN users u ON p.user_id = u.id\n    ORDER BY p.created_at DESC\n`;\n\n// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (optional)\nconst status = msg.req.query.status;\nif (status) {\n    query = `\n        SELECT \n            p.*,\n            u.username as lead_username,\n            u.email as lead_user_email\n        FROM proposals p\n        LEFT JOIN users u ON p.user_id = u.id\n        WHERE p.status = ?\n        ORDER BY p.created_at DESC\n    `;\n    msg.payload = [status];\n} else {\n    msg.payload = [];\n}\n\nmsg.topic = query;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1130,
        "y": 860,
        "wires": [
            [
                "58e2b7f6f6c8cd34"
            ]
        ]
    },
    {
        "id": "5cfae82beb71b3cf",
        "type": "mysql",
        "z": "0ae7375ee0dd9a25",
        "mydb": "545508fd4e8bfe02",
        "name": "Get Proposal",
        "x": 1340,
        "y": 580,
        "wires": [
            [
                "ce300c711d09de2e"
            ]
        ]
    },
    {
        "id": "ae79c69f33f0198d",
        "type": "function",
        "z": "0ae7375ee0dd9a25",
        "name": "Update Status Query",
        "func": "// ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£\nmsg.topic = \"UPDATE proposals SET status = ?, updated_at = NOW() WHERE id = ?\";\nmsg.payload = [msg.newStatus, msg.proposalId];\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1790,
        "y": 580,
        "wires": [
            [
                "08d2b9844bfcf805"
            ]
        ]
    },
    {
        "id": "58e2b7f6f6c8cd34",
        "type": "mysql",
        "z": "0ae7375ee0dd9a25",
        "mydb": "545508fd4e8bfe02",
        "name": "Execute List Query",
        "x": 1160,
        "y": 1020,
        "wires": [
            [
                "faa81501fe4a7e54"
            ]
        ]
    },
    {
        "id": "8c80aa3cbf8c42ef",
        "type": "catch",
        "z": "0ae7375ee0dd9a25",
        "name": "JWT Error Handler",
        "scope": [
            "7cd746e9699de1c9"
        ],
        "uncaught": false,
        "x": 500,
        "y": 740,
        "wires": [
            [
                "119a01eaac3d4ea9"
            ]
        ]
    },
    {
        "id": "08d2b9844bfcf805",
        "type": "mysql",
        "z": "0ae7375ee0dd9a25",
        "mydb": "545508fd4e8bfe02",
        "name": "Update Proposal",
        "x": 2000,
        "y": 580,
        "wires": [
            [
                "f898eb5be3517685"
            ]
        ]
    },
    {
        "id": "f898eb5be3517685",
        "type": "function",
        "z": "0ae7375ee0dd9a25",
        "name": "Create Status History",
        "func": "// ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞\nconst statusMessages = {\n    'waiting': '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö',\n    'reviewing': '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß',\n    'waiting_revision': '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞',\n    'preparing': '‡∏Å‡∏≤‡∏£‡∏±‡∏ô‡∏ï‡∏µ‡πÉ‡∏´‡πâ‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡∏ú‡∏•‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠',\n    'approved': '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£',\n    'rejected': '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'\n};\n\nconst remarks = msg.remarks || statusMessages[msg.newStatus];\n\n// ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° SQL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥\nlet historyQuery = \"INSERT INTO project_status_history (proposal_id, status, status_date, remarks, updated_by\";\nlet historyValues = [msg.proposalId, msg.newStatus, new Date(), remarks, msg.admin.userId];\n\n// ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£ reject ‡πÅ‡∏•‡∏∞‡∏°‡∏µ reason code ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πâ‡∏ß‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ column)\nif (msg.newStatus === 'rejected' && msg.rejectReason) {\n    // ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö reason ‡πÅ‡∏¢‡∏Å ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° column ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô\n    // historyQuery += \", reject_reason\";\n    // historyValues.push(msg.rejectReason);\n}\n\nhistoryQuery += \") VALUES (?, ?, ?, ?, ?)\";\n\nmsg.topic = historyQuery;\nmsg.payload = historyValues;\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1790,
        "y": 660,
        "wires": [
            [
                "18e3ba18c55dda41"
            ]
        ]
    },
    {
        "id": "18e3ba18c55dda41",
        "type": "mysql",
        "z": "0ae7375ee0dd9a25",
        "mydb": "545508fd4e8bfe02",
        "name": "Insert History",
        "x": 2000,
        "y": 660,
        "wires": [
            [
                "1232964e69b4b838"
            ]
        ]
    },
    {
        "id": "1232964e69b4b838",
        "type": "function",
        "z": "0ae7375ee0dd9a25",
        "name": "Create Notification",
        "func": "// ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ\nconst notificationMessages = {\n    'waiting': '‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö',\n    'reviewing': '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß',\n    'waiting_revision': '‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î',\n    'preparing': '‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠',\n    'approved': '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',\n    'rejected': '‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'\n};\n\nconst message = notificationMessages[msg.newStatus];\n\nmsg.topic = \"INSERT INTO status_notifications (user_id, proposal_id, status, message, created_at) VALUES (?, ?, ?, ?, NOW())\";\nmsg.payload = [msg.currentProposal.user_id, msg.proposalId, msg.newStatus, message];\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1780,
        "y": 740,
        "wires": [
            [
                "fb72259a741a7286"
            ]
        ]
    },
    {
        "id": "fb72259a741a7286",
        "type": "mysql",
        "z": "0ae7375ee0dd9a25",
        "mydb": "545508fd4e8bfe02",
        "name": "Insert Notification",
        "x": 2000,
        "y": 740,
        "wires": [
            [
                "ade173bc4c245c1b"
            ]
        ]
    },
    {
        "id": "ade173bc4c245c1b",
        "type": "function",
        "z": "0ae7375ee0dd9a25",
        "name": "Prepare Email",
        "func": "// ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•\nconst proposal = msg.currentProposal;\n\n// ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞\nconst emailSubjects = {\n    'waiting': '‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ - ' + proposal.project_title,\n    'reviewing': '‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ - ' + proposal.project_title,\n    'waiting_revision': '‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ - ' + proposal.project_title,\n    'preparing': '‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ - ' + proposal.project_title,\n    'approved': '‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ - ' + proposal.project_title,\n    'rejected': '‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ - ' + proposal.project_title\n};\n\n// ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•\nmsg.emailData = {\n    name: proposal.lead_name,\n    date: new Date().toLocaleDateString('th-TH', {\n        year: 'numeric',\n        month: 'long',\n        day: 'numeric'\n    }),\n    important_message: msg.remarks || '',\n    id: proposal.proposals_id,\n    status: msg.newStatus,\n    status_text: getStatusText(msg.newStatus),\n    process_date: new Date().toLocaleDateString('th-TH'),\n    note: msg.remarks || '',\n    action_url: \"https://adicet.cmru.ac.th/sid/dashboard\",\n    support_email: \"sidcmru@g.cmru.ac.th\",\n    current_year: new Date().getFullYear(),\n    company_address: \"180 ‡∏´‡∏°‡∏π‡πà 7 ‡∏ñ‡∏ô‡∏ô‡πÇ‡∏ä‡∏ï‡∏ô‡∏≤ ‡∏ï‡∏≥‡∏ö‡∏•‡∏Ç‡∏µ‡πâ‡πÄ‡∏´‡∏•‡πá‡∏Å ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÅ‡∏°‡πà‡∏£‡∏¥‡∏° ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà 50180\"\n};\n\nmsg.topic = emailSubjects[msg.newStatus];\nmsg.to = proposal.lead_email;\n\nreturn msg;\n\nfunction getStatusText(status) {\n    const statusTexts = {\n        'waiting': '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö',\n        'reviewing': '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß',\n        'waiting_revision': '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç',\n        'preparing': '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠',\n        'approved': '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß',\n        'rejected': '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'\n    };\n    return statusTexts[status] || status;\n}",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1770,
        "y": 820,
        "wires": [
            [
                "3383581854f093a2"
            ]
        ]
    },
    {
        "id": "3383581854f093a2",
        "type": "template",
        "z": "0ae7375ee0dd9a25",
        "name": "Email Template",
        "field": "payload",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<!DOCTYPE html>\n<html>\n<head>\n    <meta charset=\"utf-8\">\n    <title>‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</title>\n</head>\n<body style=\"font-family: 'Prompt', Arial, sans-serif; line-height: 1.6; color: #333;\">\n    <div style=\"max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1);\">\n        <div style=\"text-align: center; padding: 20px; background: linear-gradient(135deg, #FFD700, #FFA500); border-radius: 10px 10px 0 0;\">\n            <h1 style=\"color: #333; margin: 0;\">SID-CMRU</h1>\n            <p style=\"margin: 5px 0 0 0; color: #666;\">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ç‡∏±‡∏ö‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏á‡∏Ñ‡∏°</p>\n        </div>\n        \n        <div style=\"padding: 20px;\">\n            <h2>‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏Ñ‡∏∏‡∏ì{{emailData.name}}</h2>\n            \n            <p>‡∏Ç‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏£‡∏≤‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</p>\n            \n            <div style=\"background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0;\">\n                <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£:</strong> {{currentProposal.project_title}}</p>\n                <p><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á:</strong> {{emailData.id}}</p>\n                <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà:</strong> {{emailData.status_text}}</p>\n                <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó:</strong> {{emailData.process_date}}</p>\n                \n                {{!-- {{#if emailData.note}} --}}\n                {{!-- <hr style=\"border: 0; border-top: 1px dashed #ccc; margin: 15px 0;\"> --}}\n                {{!-- <p><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏/‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞:</strong></p> --}}\n                {{!-- <p style=\"white-space: pre-wrap;\">{{emailData.note}}</p> --}}\n                {{!-- {{/if}} --}}\n            </div>\n            \n            <div style=\"text-align: center; margin: 20px 0;\">\n                <a href=\"{{emailData.action_url}}\" style=\"display: inline-block; padding: 10px 20px; background: #FFD700; color: #333; text-decoration: none; border-radius: 50px; font-weight: bold;\">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</a>\n            </div>\n            \n            <p>‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠:</p>\n            <p>üìß ‡∏≠‡∏µ‡πÄ‡∏°‡∏•: {{emailData.support_email}}<br>\n            üìû ‡πÇ‡∏ó‡∏£: (+66) 65-0161100</p>\n        </div>\n        \n        <div style=\"text-align: center; padding: 15px; background: #f8f9fa; color: #666; font-size: 12px; border-radius: 0 0 10px 10px;\">\n            <p>&copy; {{emailData.current_year}} SID-CMRU. ‡∏™‡∏á‡∏ß‡∏ô‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå.</p>\n            <p>{{emailData.company_address}}</p>\n        </div>\n    </div>\n</body>\n</html>",
        "output": "str",
        "x": 1600,
        "y": 920,
        "wires": [
            [
                "a391183c45b71767"
            ]
        ]
    },
    {
        "id": "a391183c45b71767",
        "type": "function",
        "z": "0ae7375ee0dd9a25",
        "name": "Queue Email & Complete",
        "func": "// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å email ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏•‡∏á queue (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)\n// ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á email node\n\n// ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ log ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô\nnode.warn(`Email queued to: ${msg.to}`);\nnode.warn(`Subject: ${msg.topic}`);\n\n// ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á success response\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1760,
        "y": 1020,
        "wires": [
            [
                "be4ac82f3d9375f9"
            ]
        ]
    },
    {
        "id": "545508fd4e8bfe02",
        "type": "MySQLdatabase",
        "name": "",
        "host": "127.0.0.1",
        "port": "3306",
        "db": "SID",
        "tz": "",
        "charset": "UTF8"
    }
]